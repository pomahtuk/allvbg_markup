!function(){$(function(){var e,t,n,i,r,o;return r=function(e){return 0===e.level?e.name:null!=e.style_img?"<img class='mapicon' src='http://allvbg.ru/static/allvbg/"+e.style_img+"'/>"+e.name:e.name},o=function(e){return e.name},t=function(e,t,n){var i,r,o,a;for(r=[],o=0,a=e.length;a>o;o++)i=e[o],"id"===n&&(t=parseInt(t,10)),i[n]===t&&r.push(i);return r},i=function(e,n){var i,r,o,a,s,l,c,u,d,p,h,f;for(c=t(e,0,"level"),u=0,p=c.length;p>u;u++)for(o=c[u],a="/api/v1/firm/"+o.id+"/",o.children=[],r=delete o.id,o.children=t(e,a,"parent"),f=o.children,d=0,h=f.length;h>d;d++)i=f[d],s=i.map_style.split("/map_style/")[1].split("/")[0],l=t(n,s,"id")[0],i.style_img=l.value;return c},e=function(e,t){return $.ajax({url:e,dataType:"jsonp"}).done(function(e){return null!=t?t(e.objects):void 0})},n=function(){return flow.exec(function(){return e("http://allvbg.ru/api/v1/firm/?limit=120&container=true",this.MULTI("firm")),e("http://allvbg.ru/api/v1/map_style/?limit=120",this.MULTI("style"))},function(e){return window.new_results=i(e.firm,e.style),$("#id_parent").select2({data:{results:new_results,text:"name"},formatResult:r,formatSelection:o})})},$("#id_description").redactor(),$("#id_short").redactor(),n(),window.Firm={initialized:!1},window.Firm.initialize=function(){var e,t,n;return Firm.initialized?void 0:(n=[{featureType:"landscape",stylers:[{saturation:-100}]},{featureType:"water",stylers:[{saturation:-100}]},{featureType:"road",stylers:[{saturation:-100}]},{featureType:"poi",stylers:[{saturation:-100}]}],window.Firm.geocoder=new google.maps.Geocoder,t={zoom:13,center:new google.maps.LatLng(60.705288,28.762311),disableDefaultUI:!0,mapTypeId:"custom_style"},window.Firm.map=new google.maps.Map(document.getElementById("map-canvas"),t),e=new google.maps.StyledMapType(n,{name:"Grayscale"}),window.Firm.map.mapTypes.set("custom_style",e),Firm.initialized=!0,$("#b1").click(function(){return window.Firm.codeAddress()}))},window.Firm.codeAddress=function(){var e;return e=$("#address").val(),console.log(e),window.Firm.geocoder.geocode({address:e},function(e,t){var n;return t===google.maps.GeocoderStatus.OK?(window.Firm.map.setCenter(e[0].geometry.location),n=new google.maps.Marker({map:window.Firm.map,position:e[0].geometry.location,draggable:!0}),$("#id_lat").val(n.getPosition().lat()),$("#id_lng").val(n.getPosition().lng()),$("#id_location").val(""+n.getPosition().lat()+","+n.getPosition().lng()),google.maps.event.addListener(n,"dragend",function(){return $("#id_lat").val(n.getPosition().lat()),$("#id_lng").val(n.getPosition().lng()),$("#id_location").val(""+n.getPosition().lat()+","+n.getPosition().lng()),console.log($("#id_lat").val(),$("#id_lng").val())})):alert("Geocode was not successful for the following reason: "+t)})}})}.call(this);