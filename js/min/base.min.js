$(document).ready(function(){function e(e){return 0===e.level?e.name:"none"!=e.style_img&"undefined"!=e.style_img?"<img class='mapicon' src='/static/allvbg/"+e.style_img+"'/>"+e.name:e.name}function t(e){return e.name}function a(e,t,a){var n=[];for(_i=0,_len=e.length;_len>_i;_i++)item=e[_i],item[a]==t&&n.push(item);return n}function n(e,t){top_level=a(e,0,"level");var n,l,o,r;for(o=0,r=top_level.length;r>o;o++){n=top_level[o],l="/api/v1/firm/"+n.id+"/",n.children=[],delete n.id,n.children=a(e,l,"parent");var i,c,m;for(c=0,m=n.children.length;m>c;c++)i=n.children[c],style_id=i.map_style.split("/map_style/")[1].split("/")[0],style_img=a(t,style_id,"id")[0],i.style_img=style_img.value}return top_level}function l(e,t){$.ajax({url:e,dataType:"jsonp"}).done(function(e){t&&t(e.objects)})}function o(){var e=$("#id_location"),t=$("#id_lat"),a=$("#id_lng"),n=t.val(),l=a.val();n||(n=28.738031),l||(l=60.713432),map=new ymaps.Map("YMapsID",{center:[l,n],zoom:14}),map.controls.add("zoomControl").add("typeSelector"),myPlacemark=new ymaps.Placemark(map.getCenter(),{hintContent:""},{draggable:!0}),myCollection=new ymaps.GeoObjectCollection,myPlacemark.events.add("dragend",function(e){o(e,myPlacemark)}),map.geoObjects.add(myPlacemark),$("#b1").click(function(){var n=$("#YMapsInput").val();return ymaps.geocode(n,{results:1}).then(function(n){map.geoObjects.each(function(e){map.geoObjects.remove(e)}),n.geoObjects.each(function(n){center=n.geometry.getCoordinates(),map.panTo(center),e.val([center[1],center[0]]),t.val(center[1]),a.val(center[0]),geoPlacemark=new ymaps.Placemark(center,{hintContent:""},{draggable:!0}),geoPlacemark.events.add("dragend",function(e){o(e,geoPlacemark)})}),map.geoObjects.add(geoPlacemark)}),!1});var o=function(n,l){var o=l.geometry.getCoordinates();e.val([o[1],o[0]]),t.val(o[1]),a.val(o[0]),n.stopPropagation()}}flow_test=function(){flow.exec(function(){l("http://allvbg.ru/api/v1/firm/?limit=120&container=true",this.MULTI("firm")),l("http://allvbg.ru/api/v1/map_style/?limit=120",this.MULTI("style"))},function(a){window.new_results=n(a.firm,a.style),$("#id_parent").select2({data:{results:new_results,text:"name"},formatResult:e,formatSelection:t})})},$("#id_description").redactor(),$("#id_short").redactor(),flow_test(),ymaps.ready(o)});